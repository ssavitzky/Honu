#!/bin/bash
#  Select and label a workspace

USAGE="$0 [-hdk] workspace [text...]
    -h: print help text
    -D: no default date/time
    -d: show date
    -k: kill label
    -l: list workspaces
"

# Map workspace numbers and names into resistor color codes
colors () {
    case $1 in
        (0) echo "-fg white -bg black";;
        (1) echo "-fg white -bg brown";;
        (2) echo "-fg black -bg red";;
        (3) echo "-fg black -bg orange";;
        (4) echo "-fg black -bg yellow";;
        (5) echo "-fg black -bg green";;
        (6) echo "-fg black -bg blue";;
        (7) echo "-fg black -bg violet";;
        (8) echo "-fg black -bg grey";;
        (9) echo "-fg black -bg white";;
        (-) echo "-fg black -bg silver";;
        (=) echo "-fg black -bg gold";;
        (*) echo "-bg grey  -fg black";;
    esac
}

# Map workspace into key name: "-" is minus
key () {
    case $1 in
	(-) echo "minus";;
	(=) echo "equals";;
	(*) echo "$1";;
    esac
}

# Extract the first number on a line.
first_number () {
    sed -e 's/^[^0-9]*//' | sed -e 's/[^0-9].*//' 
}

# List workspaces
list () {
    ps x | grep [W]S= | sed 's/^.*-strftime //' | sed 's/%[a-zA-Z][- :]//g' | sort
}

STRFTIME=%H:%M
KILL=false
case $1 in
    (-h) echo "$USAGE"; exit;;
    (-D) STRFTIME=""; shift;;
    (-d) STRFTIME="%a %F %H:%M"; shift;;
    (-k) KILL=true; shift;;
    (-l) list; exit;;
esac

N=$1; shift
COLORS="$(colors $N)"

# kill any pre-existing bar with the same color code.
for pid in $(ps x | egrep -e "[x]clock.*$COLORS" | first_number); do
    kill $pid;
done

if $KILL; then exit 0; fi

# Get the x position from the xmonad local parameters:
XMLOCAL=$HOME/.xmonad/lib/Local.hs
WIDTH=$(grep firstTopBarWidth $XMLOCAL | first_number)

# Switch to the indicated workspace; allow time to get there.
xdotool key super+`key $N`
sleep 1

# Run the label program (xclock)
exec xclock -digital -geometry +$WIDTH+0 $COLORS -padding 0 \
            -strftime "WS=$N $STRFTIME $*  "&
