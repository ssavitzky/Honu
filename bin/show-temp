#!/bin/bash
# Show current CPU temperature.  May not work on anything but a thinkpad

# TODO:
#  o disable right-click-to-exit
#  * put raw sensor output in slave window
#  o Adjust horizontal position -- get from screen if possible
#  o rewrite using bash text processing instead of cut, etc.

while true; do
    SENSORS=$(sensors)		# save command output - we only want to do it once/loop
    LINE=$(echo "$SENSORS" | grep crit | head -1)       #  this is the line we want
    TEMP=$(echo $LINE  | cut -f 2 -d+ | cut -f 1 -d \ ) # temperature as a string
    ITEMP=$(echo $TEMP | cut -f 1 -d.)                  # truncate temp to integer
    CTEMP=$(echo $LINE | cut -f 3 -d+ | cut -f 1 -d. )  # extract critical temp.
    WTEMP=$((($CTEMP * 85) / 100))		        # warn at 85% of critical
    if [ $ITEMP -ge $CTEMP ]; then
	bg=red
	fg=black
    elif [ $ITEMP -ge $WTEMP ]; then
	bg=yellow
	fg=black
    else
	bg=
	fg=
    fi

    echo -e "^cs()\n" "^tw()" "^bg($bg)" "^fg($fg)" $TEMP ' '
    echo "$SENSORS"
    sleep 5;
    handlers="button3=exec:true;entertitle=uncollapse,unhide;button2=exit"
done | dzen2 -x 1250 -y 0 -ta r -sa l -l 25 -tw 100 -h 24 -dock #-e "$handlers"
