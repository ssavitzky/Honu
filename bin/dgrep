#!/usr/bin/perl

use strict;
use warnings;

my $less = 0;

if (@ARGV == 0 || $ARGV[0] eq "-h" || $ARGV[0] eq "--help") {
    print "usage: [options] pattern file...\n";
    print "       -h    help\n";
    print "       -l    prints as less -p DATE FILE LINE#: ... for paste\n";
    print "             use e.g., dgrep -l PATTERN | cut -d ' ' -f1-4 | sh\n";
    exit;
} elsif ($ARGV[0] eq "-l" || $ARGV[0] eq "--less") {
    $less = 1;
    shift;
}

my $pattern = shift;

my @files = (@ARGV);

if (! $files[0]) {
    @files = split /\n/, `ls */*.done to.do`;
}

while ($files[0]) {
    my $file=shift @files;
    open IN, $file;
    my $date = "";
    my $lnum = 0;
    while (<IN>) {
	my $line = $_;
	$lnum++;
	if (/^(\d\d\d\d)/) {
	    $date=$1;
	}
	if (/$pattern/) {
	    if ($less) {
		print "less -p ^$date $file $lnum: $line";
	    } else {
		print "$file:$lnum: $date: $line";
	    }
	}
    }
    close IN;
}
